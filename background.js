const INITIAL_WORDS='ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è¯­è¨€åŠ©ç† @Lang Masterï¼Œæˆ‘ä¼šè¾“å…¥ç›¸å…³çš„è¯·æ±‚ï¼Œä½ å°†æ ¹æ®`preferences`ã€`instruction`å’Œ`rules`æ¥ååŠ©æˆ‘æ›´é«˜æ•ˆæŒæ¡å’Œä½¿ç”¨ä¸€é—¨è¯­è¨€ã€‚  `preferences` /learnï¼š<ç›®æ ‡å­¦ä¹ è¯­è¨€ï¼Œé»˜è®¤English> /lang:<è¯­è¨€åå¥½ï¼Œé»˜è®¤ä¸ºâ€œEnglish+ä¸­æ–‡è§£é‡Šâ€> /lvl:<ç”¨æˆ·çš„è¯­è¨€èƒ½åŠ›ï¼Œå…¥é—¨ï¼ˆé»˜è®¤ï¼‰ï¼Œæ—¥å¸¸ï¼Œä¸“ä¸š> /style:<å£è¯­ï¼Œä¹¦é¢ï¼Œæ­£å¼> else æ­£å¼ /num:<> else 3 /éŸ³æ ‡ï¼š<å«å£°è°ƒçš„æ‹¼éŸ³ï¼Œå›½é™…éŸ³æ ‡ã€å«å£°è°ƒçš„æ—¥è¯­ç½—é©¬éŸ³>else éŸ³æ ‡ï¼ˆç¾ã€è‹±ï¼‰  `instructions` /wordï¼šå•è¯è®²è§£ ç”¨æˆ·ç”¨ä»»ä½•è¯­è¨€è¾“å…¥å•è¯ï¼Œè¯·æŒ‰ä»¥ä¸‹æ¨¡ç‰ˆè¾“å‡ºå•è¯ç›¸å…³ä¿¡æ¯ï¼š ## ğŸ“å•è¯ï¼š ç”¨è¡¨æ ¼è¾“å‡ºï¼š**å•è¯**ï¼ŒéŸ³æ ‡ï¼Œè¯æ€§ï¼ˆabbrï¼‰ï¼Œè¯æ ¹ï¼Œé‡Šä¹‰ï¼ˆä¸­ã€è‹±ï¼‰ #ä¸è¦ä½¿ç”¨ä»£ç å—å›å¤ ## ğŸ’¬ä¾‹å¥ï¼š åˆ—è¡¨è¾“å‡º/numç»„*è‹±æ–‡ä¾‹å¥*(ä¸­æ–‡ç¿»è¯‘)*ä¾‹å¥æ¥æº ## ğŸªè¿‘ä¹‰å’Œåä¹‰ï¼š åˆ—è¡¨è¾“å‡ºè¯¢é—®å•è¯çš„è¿‘ä¹‰è¯å’Œåä¹‰è¯ï¼Œå«(ä¸­æ–‡é‡Šä¹‰) ## ğŸ’¡å…³è”è®°å¿†ï¼š åˆ©ç”¨è¯æ ¹å…³è”æ³•ï¼Œåˆ—è¡¨è¾“å‡º8ä¸ªç›¸å…³çš„å•è¯ï¼Œå«é‡Šä¹‰ /basicï¼šè„šæœ¬ã€é«˜çº§è¯­è¨€æˆ–å…¶ä»–å¹¿ä¹‰è¯­è¨€çš„å­¦ä¹ è¯·æ±‚ æä¾›ç»“æ„åŒ–çš„ç« èŠ‚ï¼Œå¼•å¯¼ç”¨æˆ·å­¦ä¹  /tranï¼šç¿»è¯‘ æ£€æµ‹è¯­è¨€ï¼Œæ ¡æ­£å¹¶ç¿»è¯‘ä¸ºä¸­æ–‡ã€‚æ¨¡ç‰ˆï¼š ## ğŸ¦œç¿»è¯‘ï¼š ç¿»è¯‘ /polishï¼šæ¶¦è‰² è°ƒç”¨/tranç¿»è¯‘ä¹‹åï¼Œæ¶¦è‰²ä¸ºæ›´ä¼˜é›…çš„ä¸­æ–‡ã€‚æ¨¡ç‰ˆï¼š ## ğŸª„æ¶¦è‰²ï¼š your polish /sumï¼šæ€»ç»“ æ€»ç»“è¾“å…¥çš„è‹±æ–‡ï¼Œä¸­æ–‡è¾“å‡ºã€‚ /chatï¼šå£è¯­å¯¹è¯ æ£€æŸ¥`preferences`çš„åå¥½ï¼Œä½¿ç”¨â€œç›®æ ‡è¯­è¨€â€å’Œç”¨æˆ·å¯¹è¯ï¼Œçº æ­£å¹¶å¸®åŠ©ç”¨æˆ·æå‡å£è¯­è¡¨è¾¾ã€‚ /helpï¼šè¾“å‡ºæ”¯æŒçš„æŒ‡ä»¤æŒ‡å¼•  `rules` - æ­£ç¡®æŒ‰è¾“å‡ºæ¨¡ç‰ˆæ¸²æŸ“ markdown - ç”¨æˆ·å­¦ä¹ æ—¥è¯­æ—¶ï¼Œ/word çš„éŸ³æ ‡ä½¿ç”¨å«æ•°å­—éŸ³è°ƒçš„ç½—é©¬éŸ³éŸ³æ ‡ï¼Œå¦‚ï¼š**é›¨**ï¼šã‚ã‚â‘ ï¼ŒéŸ³æ ‡ï¼šame - å‡å¦‚å•è¯æœ‰å¤šä¸ªè¯æ€§ï¼Œåº”å…¨éƒ¨åˆ—å‡º - æä¾›è¯­è¨€æœåŠ¡å‰ï¼Œç¡®è®¤ç”¨æˆ·çš„åå¥½ - è¯·ä¸€æ­¥ä¸€æ­¥æ€è€ƒï¼Œç»™ç”¨æˆ·æä¾›ä¸“ä¸šçš„è¯­è¨€è¾…å¯¼'

chrome.runtime.onInstalled.addListener(() => {
  chrome.storage.sync.set({ apiKey: 'sk-7x-u1oG_vQWFbnko0-RdwJGgwM2m6CGuzxG2gXk4CXc' });
});

chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'lookupWord') {
    lookupWord(request.word).then(sendResponse).catch(error => {
      console.error('Error looking up word:', error);
      sendResponse({ word: request.word, definition: `Error: ${error.message}` });
    });
    return true; // ä¿æŒæ¶ˆæ¯é€šé“å¼€æ”¾ï¼Œä»¥ä¾¿å¼‚æ­¥å‘é€å“åº”
  }
});

async function lookupWord(word) {
  const cachedData = await getFromLocalStorage(word);
  if (cachedData) {
    updateLookupCount(word);
    const { definition, lookupCount } = cachedData;
    return { word: `${word} (å·²æŸ¥è¯¢${lookupCount}æ¬¡)`, definition };
  }
  let definition = "No definition found in the response.";

  const apiKey = await chrome.storage.sync.get('apiKey').then(data => data.apiKey);

  const apiUrl = "https://winglighgt-langflow.hf.space/api/v1/run/16695af6-41c6-4b0c-a7a0-6fa69d6adf3d?stream=false";
  const headers = {
    'Content-Type': 'application/json',
    'x-api-key': apiKey
  };
  const payload = {
    "input_value": `Define the word: ${word}`,
    "output_type": "chat",
    "input_type": "chat",
    "tweaks": {
      "GroqModel-snATY": {},
      "ChatInput-rBilA": {},
      "ChatOutput-ZT9GJ": {},
      "Prompt-GDHj8": {}
    }
  };

  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(payload)
    });
    const data = await response.json();

    if (data.outputs && data.outputs.length > 0) {
      const firstOutput = data.outputs[0];
      if (firstOutput.outputs && firstOutput.outputs.length > 0) {
        const results = firstOutput.outputs[0].results || {};
        const message = results.message || {};
        definition = message.text || "No definition found in the response.";
      }
    }
  } catch (error) {
    console.error('Error looking up word:', error);
    throw error;
  }

    await saveToLocalStorage(word, definition);
    const { lookupCount } = await getFromLocalStorage(word);
    return { word: `${word} (å·²æŸ¥è¯¢${lookupCount}æ¬¡)`, definition };
  
}

function getFromLocalStorage(word) {
  return new Promise((resolve, reject) => {
    chrome.storage.local.get([word], (result) => {
      if (chrome.runtime.lastError) {
        reject(chrome.runtime.lastError);
      } else {
        resolve(result[word]);
      }
    });
  });
}

function saveToLocalStorage(word, definition) {
  return new Promise((resolve, reject) => {
    getFromLocalStorage(word).then((data) => {
      const lookupData = data || { definition, lookupCount: 0 };
      lookupData.lookupCount += 1;
      chrome.storage.local.set({ [word]: lookupData }, () => {
        if (chrome.runtime.lastError) {
          reject(chrome.runtime.lastError);
        } else {
          resolve();
        }
      });
    });
  });
}

function updateLookupCount(word) {
  getFromLocalStorage(word).then((data) => {
    if (data) {
      data.lookupCount += 1;
      chrome.storage.local.set({ [word]: data });
    }
  });
}
  